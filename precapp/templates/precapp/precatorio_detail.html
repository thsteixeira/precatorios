{% extends 'base.html' %}
{% load l10n %}

{% block title %}Detalhes do Precatório - {{ precatorio.cnj }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-file-alt text-primary me-2"></i>
                    Detalhes do Precatório
                </h2>
                <div class="btn-group" role="group">
                    <a href="{% url 'precatorios' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Voltar à Lista
                    </a>
                    {% if not is_editing %}
                        <a href="?edit=true" class="btn btn-warning">
                            <i class="fas fa-edit me-1"></i>Editar
                        </a>
                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deletePrecatorioModal">
                            <i class="fas fa-trash me-1"></i>Excluir
                        </button>
                    {% endif %}
                </div>
            </div>
    </div>
</div>

<!-- Precatorio Information Card -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Informações do Precatório
                </h5>
            </div>
            <div class="card-body">
                {% if is_editing or edit_mode %}
                    <!-- Edit Mode -->
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="edit_precatorio" value="1">
                        
                        <!-- Basic Information Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-muted border-bottom pb-2 mb-3">
                                    <i class="fas fa-info-circle me-1"></i>Informações Básicas
                                </h6>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.cnj.id_for_label }}" class="form-label">
                                    <strong><i class="fas fa-hashtag me-1"></i>{{ form.cnj.label }}</strong>
                                </label>
                                {{ form.cnj }}
                                {% if form.cnj.help_text %}
                                    <div class="form-text">{{ form.cnj.help_text }}</div>
                                {% endif %}
                                {% if form.cnj.errors %}
                                    <div class="text-danger mt-1">{{ form.cnj.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.origem.id_for_label }}" class="form-label">
                                    <strong><i class="fas fa-building me-1"></i>{{ form.origem.label }}</strong>
                                </label>
                                {{ form.origem }}
                                {% if form.origem.help_text %}
                                    <div class="form-text">{{ form.origem.help_text }}</div>
                                {% endif %}
                                {% if form.origem.errors %}
                                    <div class="text-danger mt-1">{{ form.origem.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.orcamento.id_for_label }}" class="form-label">
                                    <strong><i class="fas fa-calendar-alt me-1"></i>{{ form.orcamento.label }}</strong>
                                </label>
                                {{ form.orcamento }}
                                {% if form.orcamento.errors %}
                                    <div class="text-danger mt-1">{{ form.orcamento.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.tipo.id_for_label }}" class="form-label">
                                    <strong><i class="fas fa-tag me-1"></i>{{ form.tipo.label }}</strong>
                                </label>
                                {{ form.tipo }}
                                {% if form.tipo.help_text %}
                                    <div class="form-text">{{ form.tipo.help_text }}</div>
                                {% endif %}
                                {% if form.tipo.errors %}
                                    <div class="text-danger mt-1">{{ form.tipo.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Financial Information Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-muted border-bottom pb-2 mb-3">
                                    <i class="fas fa-money-bill-wave me-1"></i>Informações Financeiras
                                </h6>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.valor_de_face.id_for_label }}" class="form-label">
                                    <strong><i class="fas fa-dollar-sign me-1"></i>{{ form.valor_de_face.label }}</strong>
                                </label>
                                {{ form.valor_de_face }}
                                {% if form.valor_de_face.help_text %}
                                    <div class="form-text">{{ form.valor_de_face.help_text }}</div>
                                {% endif %}
                                {% if form.valor_de_face.errors %}
                                    <div class="text-danger mt-1">{{ form.valor_de_face.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.ultima_atualizacao.id_for_label }}" class="form-label">
                                    <strong><i class="fas fa-chart-line me-1"></i>{{ form.ultima_atualizacao.label }}</strong>
                                </label>
                                {{ form.ultima_atualizacao }}
                                {% if form.ultima_atualizacao.help_text %}
                                    <div class="form-text">{{ form.ultima_atualizacao.help_text }}</div>
                                {% endif %}
                                {% if form.ultima_atualizacao.errors %}
                                    <div class="text-danger mt-1">{{ form.ultima_atualizacao.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.data_ultima_atualizacao.id_for_label }}" class="form-label">
                                    <strong><i class="fas fa-calendar-check me-1"></i>{{ form.data_ultima_atualizacao.label }}</strong>
                                </label>
                                {{ form.data_ultima_atualizacao }}
                                {% if form.data_ultima_atualizacao.errors %}
                                    <div class="text-danger mt-1">{{ form.data_ultima_atualizacao.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Contractual Percentages Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-muted border-bottom pb-2 mb-3">
                                    <i class="fas fa-percentage me-1"></i>Percentuais Contratuais (0% - 30%)
                                </h6>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.percentual_contratuais_assinado.id_for_label }}" class="form-label">
                                    <strong><i class="fas fa-pen me-1"></i>{{ form.percentual_contratuais_assinado.label }}</strong>
                                </label>
                                {{ form.percentual_contratuais_assinado }}
                                {% if form.percentual_contratuais_assinado.help_text %}
                                    <div class="form-text">{{ form.percentual_contratuais_assinado.help_text }}</div>
                                {% endif %}
                                {% if form.percentual_contratuais_assinado.errors %}
                                    <div class="text-danger mt-1">{{ form.percentual_contratuais_assinado.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.percentual_contratuais_apartado.id_for_label }}" class="form-label">
                                    <strong><i class="fas fa-cut me-1"></i>{{ form.percentual_contratuais_apartado.label }}</strong>
                                </label>
                                {{ form.percentual_contratuais_apartado }}
                                {% if form.percentual_contratuais_apartado.help_text %}
                                    <div class="form-text">{{ form.percentual_contratuais_apartado.help_text }}</div>
                                {% endif %}
                                {% if form.percentual_contratuais_apartado.errors %}
                                    <div class="text-danger mt-1">{{ form.percentual_contratuais_apartado.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.percentual_sucumbenciais.id_for_label }}" class="form-label">
                                    <strong><i class="fas fa-gavel me-1"></i>{{ form.percentual_sucumbenciais.label }}</strong>
                                </label>
                                {{ form.percentual_sucumbenciais }}
                                {% if form.percentual_sucumbenciais.help_text %}
                                    <div class="form-text">{{ form.percentual_sucumbenciais.help_text }}</div>
                                {% endif %}
                                {% if form.percentual_sucumbenciais.errors %}
                                    <div class="text-danger mt-1">{{ form.percentual_sucumbenciais.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Status and Situation Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-muted border-bottom pb-2 mb-3">
                                    <i class="fas fa-check-square me-1"></i>Status e Situação
                                </h6>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.credito_principal.id_for_label }}" class="form-label">
                                    <i class="fas fa-coins me-1"></i>{{ form.credito_principal.label }}
                                </label>
                                {{ form.credito_principal }}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.honorarios_contratuais.id_for_label }}" class="form-label">
                                    <i class="fas fa-file-contract me-1"></i>{{ form.honorarios_contratuais.label }}
                                </label>
                                {{ form.honorarios_contratuais }}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.honorarios_sucumbenciais.id_for_label }}" class="form-label">
                                    <i class="fas fa-balance-scale me-1"></i>{{ form.honorarios_sucumbenciais.label }}
                                </label>
                                {{ form.honorarios_sucumbenciais }}
                            </div>
                        </div>
                        
                        <!-- Documents and Observations Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-muted border-bottom pb-2 mb-3">
                                    <i class="fas fa-file-text me-1"></i>Documentos e Observações
                                </h6>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.integra_precatorio.id_for_label }}" class="form-label">
                                    <strong><i class="fas fa-file-pdf me-1"></i>{{ form.integra_precatorio.label }}</strong>
                                </label>
                                {{ form.integra_precatorio }}
                                {% if form.integra_precatorio.help_text %}
                                    <div class="form-text">{{ form.integra_precatorio.help_text }}</div>
                                {% endif %}
                                {% if form.integra_precatorio.errors %}
                                    <div class="text-danger mt-1">{{ form.integra_precatorio.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label for="{{ form.observacao.id_for_label }}" class="form-label">
                                    <strong><i class="fas fa-comment me-1"></i>{{ form.observacao.label }}</strong>
                                </label>
                                {{ form.observacao }}
                                {% if form.observacao.help_text %}
                                    <div class="form-text">{{ form.observacao.help_text }}</div>
                                {% endif %}
                                {% if form.observacao.errors %}
                                    <div class="text-danger mt-1">{{ form.observacao.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end mt-4">
                            <a href="{% url 'precatorio_detalhe' precatorio.cnj %}" class="btn btn-secondary me-2">
                                <i class="fas fa-times me-1"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-1"></i>Salvar Alterações
                            </button>
                        </div>
                    </form>
                {% else %}
                    <!-- View Mode -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong><i class="fas fa-hashtag me-1"></i>CNJ:</strong><br>
                            <span class="text-primary fs-5">{{ precatorio.cnj }}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong><i class="fas fa-building me-1"></i>CNJ de Origem:</strong><br>
                            <span class="text-muted">{{ precatorio.origem }}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong><i class="fas fa-calendar-alt me-1"></i>Ano do Orçamento:</strong><br>
                            <span class="text-muted">{{ precatorio.orcamento }}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong><i class="fas fa-tag me-1"></i>Tipo de Precatório:</strong><br>
                            {% if precatorio.tipo %}
                                <span class="badge" style="background-color: {{ precatorio.tipo.cor }}; color: white;">
                                    {{ precatorio.tipo.nome }}
                                </span>
                            {% else %}
                                <span class="text-muted">Não definido</span>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong><i class="fas fa-money-bill-wave me-1"></i>Valor de Face:</strong><br>
                            <span class="text-success fs-5 fw-bold">R$ {{ precatorio.valor_de_face|floatformat:2 }}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong><i class="fas fa-chart-line me-1"></i>Última Atualização Monetária:</strong><br>
                            <span class="text-success fs-5 fw-bold">R$ {{ precatorio.ultima_atualizacao|floatformat:2 }}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong><i class="fas fa-calendar-check me-1"></i>Data da Última Atualização:</strong><br>
                            <span class="text-muted">{{ precatorio.data_ultima_atualizacao|date:"d/m/Y" }}</span>
                        </div>
                        
                        <!-- Percentage Fields -->
                        <div class="col-md-6 mb-3">
                            <strong><i class="fas fa-percentage me-1"></i>Percentual Contratuais Assinado:</strong><br>
                            <span class="text-info fs-5 fw-bold">{{ precatorio.percentual_contratuais_assinado|floatformat:2 }}%</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong><i class="fas fa-percentage me-1"></i>Percentual Contratuais Apartado:</strong><br>
                            <span class="text-warning fs-5 fw-bold">{{ precatorio.percentual_contratuais_apartado|floatformat:2 }}%</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong><i class="fas fa-percentage me-1"></i>Percentual Sucumbenciais:</strong><br>
                            <span class="text-danger fs-5 fw-bold">{{ precatorio.percentual_sucumbenciais|floatformat:2 }}%</span>
                        </div>
                        
                        <!-- Status dos Pagamentos -->
                        <div class="col-12 mb-3">
                            <hr class="my-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6><strong><i class="fas fa-tags me-1"></i>Status dos Pagamentos:</strong></h6>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleStatusPagamentoEdit()">
                                    <i class="fas fa-edit me-1"></i>Editar Status
                                </button>
                            </div>
                            
                            <!-- Status Display -->
                            <div id="status-pagamento-display">
                                <div class="d-flex flex-wrap gap-2">
                                    <span class="badge bg-info fs-6">
                                        <i class="fas fa-coins me-1"></i>Principal: {{ precatorio.get_credito_principal_display }}
                                    </span>
                                    <span class="badge bg-success fs-6">
                                        <i class="fas fa-file-contract me-1"></i>Contratuais: {{ precatorio.get_honorarios_contratuais_display }}
                                    </span>
                                    <span class="badge bg-warning text-dark fs-6">
                                        <i class="fas fa-balance-scale me-1"></i>Sucumbenciais: {{ precatorio.get_honorarios_sucumbenciais_display }}
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Status Edit Form -->
                            <div id="status-pagamento-edit" style="display: none;">
                                <form method="post" class="inline-edit-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="update_payment_status" value="1">
                                    
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label for="credito_principal" class="form-label">
                                                <i class="fas fa-coins me-1"></i>Status Principal
                                            </label>
                                            <select name="credito_principal" class="form-select form-select-sm" id="credito_principal">
                                                <option value="pendente" {% if precatorio.credito_principal == 'pendente' %}selected{% endif %}>Pendente</option>
                                                <option value="parcial" {% if precatorio.credito_principal == 'parcial' %}selected{% endif %}>Parcial</option>
                                                <option value="quitado" {% if precatorio.credito_principal == 'quitado' %}selected{% endif %}>Quitado</option>
                                                <option value="vendido" {% if precatorio.credito_principal == 'vendido' %}selected{% endif %}>Vendido</option>
                                                <option value="inaplicável" {% if precatorio.credito_principal == 'inaplicável' %}selected{% endif %}>Inaplicável</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="honorarios_contratuais" class="form-label">
                                                <i class="fas fa-file-contract me-1"></i>Status Contratuais
                                            </label>
                                            <select name="honorarios_contratuais" class="form-select form-select-sm" id="honorarios_contratuais">
                                                <option value="pendente" {% if precatorio.honorarios_contratuais == 'pendente' %}selected{% endif %}>Pendente</option>
                                                <option value="parcial" {% if precatorio.honorarios_contratuais == 'parcial' %}selected{% endif %}>Parcial</option>
                                                <option value="quitado" {% if precatorio.honorarios_contratuais == 'quitado' %}selected{% endif %}>Quitado</option>
                                                <option value="vendido" {% if precatorio.honorarios_contratuais == 'vendido' %}selected{% endif %}>Vendido</option>
                                                <option value="inaplicável" {% if precatorio.honorarios_contratuais == 'inaplicável' %}selected{% endif %}>Inaplicável</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="honorarios_sucumbenciais" class="form-label">
                                                <i class="fas fa-balance-scale me-1"></i>Status Sucumbenciais
                                            </label>
                                            <select name="honorarios_sucumbenciais" class="form-select form-select-sm" id="honorarios_sucumbenciais">
                                                <option value="pendente" {% if precatorio.honorarios_sucumbenciais == 'pendente' %}selected{% endif %}>Pendente</option>
                                                <option value="parcial" {% if precatorio.honorarios_sucumbenciais == 'parcial' %}selected{% endif %}>Parcial</option>
                                                <option value="quitado" {% if precatorio.honorarios_sucumbenciais == 'quitado' %}selected{% endif %}>Quitado</option>
                                                <option value="vendido" {% if precatorio.honorarios_sucumbenciais == 'vendido' %}selected{% endif %}>Vendido</option>
                                                <option value="inaplicável" {% if precatorio.honorarios_sucumbenciais == 'inaplicável' %}selected{% endif %}>Inaplicável</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex gap-2 mt-3">
                                        <button type="submit" class="btn btn-sm btn-success">
                                            <i class="fas fa-save me-1"></i>Salvar
                                        </button>
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="toggleStatusPagamentoEdit()">
                                            <i class="fas fa-times me-1"></i>Cancelar
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Documentos e Observações -->
                        <div class="col-12 mb-3">
                            <hr class="my-4">
                            <h6><strong><i class="fas fa-file-text me-1"></i>Documentos e Observações:</strong></h6>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong><i class="fas fa-file-pdf me-1"></i>Arquivo da Íntegra do Precatório:</strong><br>
                            
                            <!-- File Display -->
                            <div id="file-display">
                                {% if precatorio.integra_precatorio %}
                                    <div class="btn-group" role="group" aria-label="Ações do arquivo">
                                        <a href="{% url 'download_precatorio_file' precatorio.cnj %}" target="_blank" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-download me-1"></i>Baixar PDF
                                        </a>
                                        <button type="button" class="btn btn-outline-success btn-sm" onclick="toggleFileEdit()">
                                            <i class="fas fa-edit me-1"></i>Substituir
                                        </button>
                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="confirmFileDelete()">
                                            <i class="fas fa-trash me-1"></i>Excluir
                                        </button>
                                    </div>
                                    <small class="text-muted d-block mt-1">{{ precatorio.integra_precatorio.name|slice:"20:" }}</small>
                                {% else %}
                                    <span class="text-muted d-block mb-2">Nenhum arquivo disponível</span>
                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="toggleFileEdit()">
                                        <i class="fas fa-upload me-1"></i>Enviar Arquivo
                                    </button>
                                {% endif %}
                            </div>
                            
                            <!-- File Edit Form -->
                            <div id="file-edit" style="display: none;">
                                <form method="post" enctype="multipart/form-data" class="inline-edit-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="update_file" value="1">
                                    <div class="mb-2">
                                        <input type="file" name="integra_precatorio" class="form-control" accept=".pdf" required>
                                        <small class="form-text text-muted">
                                            {% if precatorio.integra_precatorio %}
                                                Selecione um arquivo PDF para substituir o arquivo atual
                                            {% else %}
                                                Selecione um arquivo PDF para enviar
                                            {% endif %}
                                        </small>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-sm btn-success">
                                            <i class="fas fa-save me-1"></i>
                                            {% if precatorio.integra_precatorio %}Substituir{% else %}Enviar{% endif %}
                                        </button>
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="toggleFileEdit()">
                                            <i class="fas fa-times me-1"></i>Cancelar
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- File Delete Form (hidden) -->
                            <form id="delete-file-form" method="post" style="display: none;">
                                {% csrf_token %}
                                <input type="hidden" name="delete_file" value="1">
                            </form>
                        </div>
                        <div class="col-12 mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong><i class="fas fa-comment me-1"></i>Observações:</strong>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleObservacaoEdit()">
                                    <i class="fas fa-edit me-1"></i>Editar Observações
                                </button>
                            </div>
                            
                            <!-- Observacao Display -->
                            <div id="observacao-display">
                                {% if precatorio.observacao %}
                                    <div class="border rounded p-3 bg-light">
                                        {{ precatorio.observacao|linebreaks }}
                                    </div>
                                {% else %}
                                    <span class="text-muted">Nenhuma observação</span>
                                {% endif %}
                            </div>
                            
                            <!-- Observacao Edit Form -->
                            <div id="observacao-edit" style="display: none;">
                                <form method="post" class="inline-edit-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="update_observacao" value="1">
                                    <div class="mb-2">
                                        <textarea name="observacao" class="form-control" rows="4" placeholder="Digite observações gerais sobre o precatório...">{{ precatorio.observacao|default:"" }}</textarea>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-sm btn-success">
                                            <i class="fas fa-save me-1"></i>Salvar
                                        </button>
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="toggleObservacaoEdit()">
                                            <i class="fas fa-times me-1"></i>Cancelar
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Summary Card (View Mode Only) -->
{% if not is_editing and not edit_mode %}
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-money-bill-wave fa-2x text-success mb-2"></i>
                <h5 class="text-success">R$ {{ precatorio.valor_de_face|floatformat:2 }}</h5>
                <small class="text-muted">Valor de Face</small>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                <h5 class="text-info">R$ {{ precatorio.ultima_atualizacao|floatformat:2 }}</h5>
                <small class="text-muted">Valor Atualizado</small>
            </div>
        </div>
    </div>
</div>

<!-- Second Row for Percentages -->
<div class="row mt-3">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-percentage fa-2x text-primary mb-2"></i>
                <h5 class="text-primary">{{ precatorio.percentual_contratuais_assinado|floatformat:2 }}%</h5>
                <small class="text-muted">% Contratuais Assinado</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-percentage fa-2x text-warning mb-2"></i>
                <h5 class="text-warning">{{ precatorio.percentual_contratuais_apartado|floatformat:2 }}%</h5>
                <small class="text-muted">% Contratuais Apartado</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-percentage fa-2x text-danger mb-2"></i>
                <h5 class="text-danger">{{ precatorio.percentual_sucumbenciais|floatformat:2 }}%</h5>
                <small class="text-muted">% Sucumbenciais</small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Clients Section -->
{% if not is_editing and not edit_mode %}



<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>
                        Clientes Associados
                        <span class="badge bg-light text-dark ms-2">{{ associated_clientes.count }}</span>
                    </h5>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-light btn-sm" data-bs-toggle="collapse" data-bs-target="#novoClienteForm">
                            <i class="fas fa-user-plus me-1"></i>Novo Cliente
                        </button>
                        <button type="button" class="btn btn-outline-light btn-sm" data-bs-toggle="collapse" data-bs-target="#linkClienteForm">
                            <i class="fas fa-link me-1"></i>Vincular Existente
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- New Cliente Form (Collapsible) -->
                <div class="collapse mb-4" id="novoClienteForm">
                    <div class="card bg-light">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-user-plus me-2"></i>
                                Criar Novo Cliente
                            </h6>
                        </div>
                        <div class="card-body">
                            <form method="post">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ cliente_form.cpf.id_for_label }}">CPF ou CNPJ</label>
                                            {{ cliente_form.cpf }}
                                            {% if cliente_form.cpf.help_text %}
                                                <small class="form-text text-muted">Informe o CPF ou CNPJ do cliente. Aceita formatos com ou sem pontuação.</small>
                                            {% endif %}
                                            {% if cliente_form.cpf.errors %}
                                                <div class="text-danger small">
                                                    {% for error in cliente_form.cpf.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ cliente_form.nome.label_tag }}
                                            {{ cliente_form.nome }}
                                            {% if cliente_form.nome.help_text %}
                                                <small class="form-text text-muted">{{ cliente_form.nome.help_text }}</small>
                                            {% endif %}
                                            {% if cliente_form.nome.errors %}
                                                <div class="text-danger small">
                                                    {% for error in cliente_form.nome.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ cliente_form.nascimento.label_tag }}
                                            {{ cliente_form.nascimento }}
                                            {% if cliente_form.nascimento.help_text %}
                                                <small class="form-text text-muted">{{ cliente_form.nascimento.help_text }}</small>
                                            {% endif %}
                                            {% if cliente_form.nascimento.errors %}
                                                <div class="text-danger small">
                                                    {% for error in cliente_form.nascimento.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <div class="form-check">
                                                {{ cliente_form.prioridade }}
                                                {{ cliente_form.prioridade.label_tag }}
                                                {% if cliente_form.prioridade.help_text %}
                                                    <small class="form-text text-muted d-block">{{ cliente_form.prioridade.help_text }}</small>
                                                {% endif %}
                                                {% if cliente_form.prioridade.errors %}
                                                    <div class="text-danger small">
                                                        {% for error in cliente_form.prioridade.errors %}{{ error }}{% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <div class="form-check">
                                                {{ cliente_form.falecido }}
                                                <label class="form-check-label" for="{{ cliente_form.falecido.id_for_label }}">
                                                    <i class="fas fa-cross me-1"></i>{{ cliente_form.falecido.label }}
                                                </label>
                                                {% if cliente_form.falecido.help_text %}
                                                    <small class="form-text text-muted d-block">{{ cliente_form.falecido.help_text }}</small>
                                                {% endif %}
                                                {% if cliente_form.falecido.errors %}
                                                    <div class="text-danger small">
                                                        {% for error in cliente_form.falecido.errors %}{{ error }}{% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-3">
                                            {{ cliente_form.observacao.label_tag }}
                                            {{ cliente_form.observacao }}
                                            {% if cliente_form.observacao.help_text %}
                                                <small class="form-text text-muted">{{ cliente_form.observacao.help_text }}</small>
                                            {% endif %}
                                            {% if cliente_form.observacao.errors %}
                                                <div class="text-danger small">
                                                    {% for error in cliente_form.observacao.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-end">
                                    <button type="button" class="btn btn-secondary me-2" data-bs-toggle="collapse" data-bs-target="#novoClienteForm">
                                        <i class="fas fa-times me-1"></i>Cancelar
                                    </button>
                                    <button type="submit" name="create_cliente" class="btn btn-success">
                                        <i class="fas fa-save me-1"></i>Criar Cliente
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Link Existing Cliente Form (Collapsible) -->
                <div class="collapse mb-4" id="linkClienteForm">
                    <div class="card bg-light">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-link me-2"></i>
                                Vincular Cliente Existente
                            </h6>
                        </div>
                        <div class="card-body">
                            <form method="post">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            {{ client_search_form.cpf.label_tag }}
                                            {{ client_search_form.cpf }}
                                            {% if client_search_form.cpf.help_text %}
                                                <small class="form-text text-muted">{{ client_search_form.cpf.help_text }}</small>
                                            {% endif %}
                                            {% if client_search_form.cpf.errors %}
                                                <div class="text-danger small">
                                                    {% for error in client_search_form.cpf.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4 d-flex align-items-end">
                                        <div class="d-flex gap-2 w-100">
                                            <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#linkClienteForm">
                                                <i class="fas fa-times me-1"></i>Cancelar
                                            </button>
                                            <button type="submit" name="link_cliente" class="btn btn-primary">
                                                <i class="fas fa-link me-1"></i>Vincular
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Clients List -->
                {% if associated_clientes %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th><i class="fas fa-user me-1"></i>Nome</th>
                                    <th><i class="fas fa-id-card me-1"></i>CPF ou CNPJ</th>
                                    <th><i class="fas fa-calendar me-1"></i>Nascimento</th>
                                    <th><i class="fas fa-star me-1"></i>Prioridade</th>
                                    <th><i class="fas fa-info-circle me-1"></i>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cliente in associated_clientes %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                                <i class="fas fa-user text-white"></i>
                                            </div>
                                            <div>
                                                <a href="{% url 'cliente_detail' cliente.cpf %}" class="text-decoration-none">
                                                    <strong class="text-primary">{{ cliente.nome }}</strong>
                                                </a>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="text-muted">{{ cliente.cpf }}</span>
                                    </td>
                                    <td>
                                        <span class="text-muted">{{ cliente.nascimento|date:"d/m/Y" }}</span>
                                    </td>
                                    <td>
                                        {% if cliente.prioridade %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-star me-1"></i>Prioridade
                                            </span>
                                        {% else %}
                                            <span class="badge bg-light text-dark">Normal</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if cliente.falecido %}
                                            <span class="badge bg-dark text-white">
                                                <i class="fas fa-cross me-1"></i>Falecido(a)
                                            </span>
                                        {% else %}
                                            <span class="badge bg-success text-white">
                                                <i class="fas fa-heartbeat me-1"></i>Ativo
                                            </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">Nenhum cliente associado</h6>
                        <p class="text-muted">Clique em "Novo Cliente" para criar e vincular um cliente ou "Vincular Existente" para vincular um cliente já cadastrado.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}


<!-- Requerimentos Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-file-signature me-2"></i>
                        Requerimentos
                        <span class="badge bg-light text-dark ms-2">{{ requerimentos.count }}</span>
                    </h5>
                    <button type="button" class="btn btn-outline-light btn-sm" data-bs-toggle="collapse" data-bs-target="#novoRequerimentoForm">
                        <i class="fas fa-plus me-1"></i>Novo Requerimento
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- New Requerimento Form (Collapsible) -->
                <div class="collapse mb-4" id="novoRequerimentoForm">
                    <div class="card bg-light">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-plus-circle me-2"></i>
                                Adicionar Novo Requerimento
                            </h6>
                        </div>
                        <div class="card-body">
                            <form method="post">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ requerimento_form.cliente_cpf.label_tag }}
                                            {{ requerimento_form.cliente_cpf }}
                                            {% if requerimento_form.cliente_cpf.help_text %}
                                                <small class="form-text text-muted">{{ requerimento_form.cliente_cpf.help_text }}</small>
                                            {% endif %}
                                            {% if requerimento_form.cliente_cpf.errors %}
                                                <div class="text-danger small">
                                                    {% for error in requerimento_form.cliente_cpf.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ requerimento_form.pedido.label_tag }}
                                            {{ requerimento_form.pedido }}
                                            {% if requerimento_form.pedido.help_text %}
                                                <small class="form-text text-muted">{{ requerimento_form.pedido.help_text }}</small>
                                            {% endif %}
                                            {% if requerimento_form.pedido.errors %}
                                                <div class="text-danger small">
                                                    {% for error in requerimento_form.pedido.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            {{ requerimento_form.valor.label_tag }}
                                            {{ requerimento_form.valor }}
                                            {% if requerimento_form.valor.help_text %}
                                                <small class="form-text text-muted">{{ requerimento_form.valor.help_text }}</small>
                                            {% endif %}
                                            {% if requerimento_form.valor.errors %}
                                                <div class="text-danger small">
                                                    {% for error in requerimento_form.valor.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            {{ requerimento_form.desagio.label_tag }}
                                            {{ requerimento_form.desagio }}
                                            {% if requerimento_form.desagio.help_text %}
                                                <small class="form-text text-muted">{{ requerimento_form.desagio.help_text }}</small>
                                            {% endif %}
                                            {% if requerimento_form.desagio.errors %}
                                                <div class="text-danger small">
                                                    {% for error in requerimento_form.desagio.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            {{ requerimento_form.fase.label_tag }}
                                            {{ requerimento_form.fase }}
                                            {% if requerimento_form.fase.help_text %}
                                                <small class="form-text text-muted">{{ requerimento_form.fase.help_text }}</small>
                                            {% endif %}
                                            {% if requerimento_form.fase.errors %}
                                                <div class="text-danger small">
                                                    {% for error in requerimento_form.fase.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-end">
                                    <button type="button" class="btn btn-secondary me-2" data-bs-toggle="collapse" data-bs-target="#novoRequerimentoForm">
                                        <i class="fas fa-times me-1"></i>Cancelar
                                    </button>
                                    <button type="submit" name="create_requerimento" class="btn btn-success">
                                        <i class="fas fa-save me-1"></i>Salvar Requerimento
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Requerimentos List -->
                {% if requerimentos %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Cliente</th>
                                    <th>Tipo de Pedido</th>
                                    <th>Valor</th>
                                    <th>Deságio</th>
                                    <th>Fase Principal</th>
                                    <th>Última Alteração</th>
                                    <th><i class="fas fa-cog me-1"></i>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for requerimento in requerimentos %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-user-circle text-secondary me-2"></i>
                                            <div>
                                                <strong>{{ requerimento.cliente.nome }}</strong>
                                                <br>
                                                <small class="text-muted">CPF ou CNPJ: {{ requerimento.cliente.cpf }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if requerimento.pedido %}
                                            <span class="badge text-white" style="background-color: {{ requerimento.pedido.cor }};">
                                                {{ requerimento.pedido.nome }}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">Não informado</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="text-success fw-bold">R$ {{ requerimento.valor|floatformat:2 }}</span>
                                    </td>
                                    <td>
                                        <span class="text-warning">{{ requerimento.desagio|floatformat:2 }}%</span>
                                    </td>
                                    <td>
                                        {% if requerimento.fase %}
                                            <div class="d-flex align-items-center">
                                                <div class="fase-color-dot me-2" style="background-color: {{ requerimento.fase.cor }};"></div>
                                                <span class="badge" style="background-color: {{ requerimento.fase.cor }}; color: white;">
                                                    {{ requerimento.fase.nome }}
                                                </span>
                                            </div>
                                        {% else %}
                                            <span class="badge bg-secondary">Fase não definida</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="text-muted" style="font-size: 0.7rem;">
                                            {% if requerimento.fase_ultima_alteracao %}
                                                <div>
                                                    <i class="fas fa-clock me-1"></i>
                                                    <strong>Fase:</strong> {{ requerimento.fase_ultima_alteracao|date:"d/m/y" }}
                                                </div>
                                                {% if requerimento.fase_alterada_por %}
                                                    <div class="mt-1">
                                                        <i class="fas fa-user me-1"></i>
                                                        {{ requerimento.fase_alterada_por }}
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                            {% if requerimento.fase_honorarios_ultima_alteracao %}
                                                <div class="text-muted mt-1">
                                                    <i class="fas fa-coins me-1"></i>
                                                    <strong>Hon.:</strong> {{ requerimento.fase_honorarios_ultima_alteracao|date:"d/m/y" }}
                                                </div>
                                                {% if requerimento.fase_honorarios_alterada_por %}
                                                    <div class="text-muted">
                                                        <i class="fas fa-user me-1"></i>
                                                        {{ requerimento.fase_honorarios_alterada_por }}
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                            {% if not requerimento.fase_ultima_alteracao and not requerimento.fase_honorarios_ultima_alteracao %}
                                                <span class="text-muted">Nenhuma alteração registrada</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-outline-primary" 
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#editRequerimentoForm-{{ requerimento.id }}" 
                                                    aria-expanded="false" 
                                                    title="Editar requerimento">
                                                <i class="fas fa-edit me-1"></i>Editar
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- Dropdown Edit Form for this Requerimento -->
                                <tr>
                                    <td colspan="7" class="p-0">
                                        <div class="collapse" id="editRequerimentoForm-{{ requerimento.id }}">
                                            <div class="card card-body m-2 bg-light">
                                                <form method="post" action="{% url 'precatorio_detalhe' precatorio.cnj %}">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="requerimento_id" value="{{ requerimento.id }}">
                                                    
                                                    <div class="row mb-3">
                                                        <div class="col-12">
                                                            <h6 class="text-primary mb-3">
                                                                <i class="fas fa-edit me-2"></i>Editar Requerimento - {{ requerimento.cliente.nome }}
                                                            </h6>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="row g-3">
                                                        <div class="col-md-6">
                                                            <label for="cliente_cpf_{{ requerimento.id }}" class="form-label">CPF ou CNPJ do Cliente</label>
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   id="cliente_cpf_{{ requerimento.id }}" 
                                                                   name="cliente_cpf" 
                                                                   value="{{ requerimento.cliente.cpf }}"
                                                                   readonly
                                                                   style="background-color: #f8f9fa;">
                                                            <small class="form-text text-muted">Cliente: {{ requerimento.cliente.nome }}</small>
                                                        </div>
                                                        
                                                        <div class="col-md-6">
                                                            <label for="pedido_{{ requerimento.id }}" class="form-label">Tipo de Pedido</label>
                                                            <select class="form-select form-select-sm" id="pedido_{{ requerimento.id }}" name="pedido">
                                                                <option value="">Selecione o tipo de pedido</option>
                                                                {% for pedido in available_pedidos %}
                                                                    <option value="{{ pedido.id }}" {% if requerimento.pedido.id == pedido.id %}selected{% endif %}>{{ pedido.nome }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        
                                                        <div class="col-md-6">
                                                            <label for="fase_{{ requerimento.id }}" class="form-label">Fase Principal</label>
                                                            <select class="form-select form-select-sm" id="fase_{{ requerimento.id }}" name="fase">
                                                                <option value="">Selecione a fase principal</option>
                                                                {% for fase in requerimento_fases %}
                                                                    <option value="{{ fase.id }}" {% if requerimento.fase and requerimento.fase.id == fase.id %}selected{% endif %}>
                                                                        {{ fase.nome }}
                                                                    </option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        
                                                        <div class="col-md-6">
                                                            <label for="valor_{{ requerimento.id }}" class="form-label">Valor</label>
                                                            <div class="input-group input-group-sm">
                                                                <span class="input-group-text">R$</span>
                                                                <input type="text" class="form-control brazilian-currency" 
                                                                       id="valor_{{ requerimento.id }}" 
                                                                       name="valor" 
                                                                       value="{{ requerimento.valor }}" required>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="col-md-6">
                                                            <label for="desagio_{{ requerimento.id }}" class="form-label">Deságio (%)</label>
                                                            <div class="input-group input-group-sm">
                                                                <input type="text" class="form-control brazilian-number" 
                                                                       id="desagio_{{ requerimento.id }}" 
                                                                       name="desagio" 
                                                                       value="{{ requerimento.desagio }}" 
                                                                       min="0" max="100">
                                                                <span class="input-group-text">%</span>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="col-md-6">
                                                            <div class="d-flex align-items-center h-100">
                                                                <div class="text-muted small">
                                                                    <i class="fas fa-info-circle me-1"></i>
                                                                    Todos os campos serão atualizados com os valores inseridos
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="row mt-3">
                                                        <div class="col-12">
                                                            <div class="d-flex justify-content-between">
                                                                <div class="btn-group">
                                                                    <button type="button" class="btn btn-secondary btn-sm" 
                                                                            data-bs-toggle="collapse" 
                                                                            data-bs-target="#editRequerimentoForm-{{ requerimento.id }}">
                                                                        <i class="fas fa-times me-1"></i>Cancelar
                                                                    </button>
                                                                    <button type="submit" name="update_requerimento" class="btn btn-success btn-sm">
                                                                        <i class="fas fa-save me-1"></i>Salvar Alterações
                                                                    </button>
                                                                </div>
                                                                
                                                                <button type="button" class="btn btn-danger btn-sm" 
                                                                        data-bs-toggle="modal" 
                                                                        data-bs-target="#deleteRequerimentoModal-{{ requerimento.id }}">
                                                                    <i class="fas fa-trash me-1"></i>Excluir Requerimento
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- Delete Confirmation Modal -->
                                <div class="modal fade" id="deleteRequerimentoModal-{{ requerimento.id }}" tabindex="-1" aria-labelledby="deleteRequerimentoModalLabel-{{ requerimento.id }}" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header bg-danger text-white">
                                                <h5 class="modal-title" id="deleteRequerimentoModalLabel-{{ requerimento.id }}">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Exclusão
                                                </h5>
                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="text-center">
                                                    <i class="fas fa-file-signature fa-3x text-danger mb-3"></i>
                                                    <h6>Tem certeza que deseja excluir este requerimento?</h6>
                                                    <p class="text-muted mb-0">
                                                        <strong>Cliente:</strong> {{ requerimento.cliente.nome }}<br>
                                                        <strong>Tipo:</strong> 
                                                        {% if requerimento.pedido %}
                                                            {{ requerimento.pedido.nome }}
                                                        {% else %}
                                                            Não informado
                                                        {% endif %}<br>
                                                        <strong>Valor:</strong> R$ {{ requerimento.valor|floatformat:2 }}
                                                    </p>
                                                    <div class="alert alert-warning mt-3">
                                                        <small><i class="fas fa-warning me-1"></i>Esta ação não pode ser desfeita!</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    <i class="fas fa-times me-1"></i>Cancelar
                                                </button>
                                                <form method="post" action="{% url 'precatorio_detalhe' precatorio.cnj %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="requerimento_id" value="{{ requerimento.id }}">
                                                    <button type="submit" name="delete_requerimento" class="btn btn-danger">
                                                        <i class="fas fa-trash me-1"></i>Excluir Definitivamente
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-file-signature fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">Nenhum requerimento encontrado</h6>
                        <p class="text-muted">Clique em "Novo Requerimento" para adicionar o primeiro requerimento a este precatório.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>


<!-- Alvaras Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-file-contract me-2"></i>
                        Alvarás Emitidos
                        <span class="badge bg-light text-dark ms-2">{{ alvaras.count }}</span>
                    </h5>
                    <button type="button" class="btn btn-outline-light btn-sm" data-bs-toggle="collapse" data-bs-target="#novoAlvaraForm">
                        <i class="fas fa-plus me-1"></i>Novo Alvará
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- New Alvara Form (Collapsible) -->
                <div class="collapse mb-4" id="novoAlvaraForm">
                    <div class="card bg-light">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-file-contract me-2"></i>
                                Criar Novo Alvará
                            </h6>
                        </div>
                        <div class="card-body">
                            <form method="post">
                                {% csrf_token %}
                                <!-- Cliente and Type fields -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ alvara_form.cliente_cpf.label_tag }}
                                            {{ alvara_form.cliente_cpf }}
                                            {% if alvara_form.cliente_cpf.help_text %}
                                                <small class="form-text text-muted">{{ alvara_form.cliente_cpf.help_text }}</small>
                                            {% endif %}
                                            {% if alvara_form.cliente_cpf.errors %}
                                                <div class="text-danger small">
                                                    {% for error in alvara_form.cliente_cpf.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ alvara_form.tipo.label_tag }}
                                            {{ alvara_form.tipo }}
                                            {% if alvara_form.tipo.help_text %}
                                                <small class="form-text text-muted">{{ alvara_form.tipo.help_text }}</small>
                                            {% endif %}
                                            {% if alvara_form.tipo.errors %}
                                                <div class="text-danger small">
                                                    {% for error in alvara_form.tipo.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Principal Value and Phase together -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label text-success">
                                                <i class="fas fa-dollar-sign me-1"></i>{{ alvara_form.valor_principal.label }}
                                            </label>
                                            {{ alvara_form.valor_principal }}
                                            {% if alvara_form.valor_principal.help_text %}
                                                <small class="form-text text-muted">{{ alvara_form.valor_principal.help_text }}</small>
                                            {% endif %}
                                            {% if alvara_form.valor_principal.errors %}
                                                <div class="text-danger small">
                                                    {% for error in alvara_form.valor_principal.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label text-success">
                                                <i class="fas fa-layer-group me-1"></i>{{ alvara_form.fase.label }}
                                            </label>
                                            {{ alvara_form.fase }}
                                            {% if alvara_form.fase.help_text %}
                                                <small class="form-text text-muted">{{ alvara_form.fase.help_text }}</small>
                                            {% endif %}
                                            {% if alvara_form.fase.errors %}
                                                <div class="text-danger small">
                                                    {% for error in alvara_form.fase.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Contractual Fees Value and Phase together -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label text-info">
                                                <i class="fas fa-coins me-1"></i>{{ alvara_form.honorarios_contratuais.label }}
                                            </label>
                                            {{ alvara_form.honorarios_contratuais }}
                                            {% if alvara_form.honorarios_contratuais.help_text %}
                                                <small class="form-text text-muted">{{ alvara_form.honorarios_contratuais.help_text }}</small>
                                            {% endif %}
                                            {% if alvara_form.honorarios_contratuais.errors %}
                                                <div class="text-danger small">
                                                    {% for error in alvara_form.honorarios_contratuais.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label text-info">
                                                <i class="fas fa-coins me-1"></i>{{ alvara_form.fase_honorarios_contratuais.label }}
                                            </label>
                                            {{ alvara_form.fase_honorarios_contratuais }}
                                            {% if alvara_form.fase_honorarios_contratuais.help_text %}
                                                <small class="form-text text-muted">{{ alvara_form.fase_honorarios_contratuais.help_text }}</small>
                                            {% endif %}
                                            {% if alvara_form.fase_honorarios_contratuais.errors %}
                                                <div class="text-danger small">
                                                    {% for error in alvara_form.fase_honorarios_contratuais.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Sucumbential Fees Value and Phase together -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label text-warning">
                                                <i class="fas fa-balance-scale me-1"></i>{{ alvara_form.honorarios_sucumbenciais.label }}
                                            </label>
                                            {{ alvara_form.honorarios_sucumbenciais }}
                                            {% if alvara_form.honorarios_sucumbenciais.help_text %}
                                                <small class="form-text text-muted">{{ alvara_form.honorarios_sucumbenciais.help_text }}</small>
                                            {% endif %}
                                            {% if alvara_form.honorarios_sucumbenciais.errors %}
                                                <div class="text-danger small">
                                                    {% for error in alvara_form.honorarios_sucumbenciais.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label text-warning">
                                                <i class="fas fa-balance-scale me-1"></i>{{ alvara_form.fase_honorarios_sucumbenciais.label }}
                                            </label>
                                            {{ alvara_form.fase_honorarios_sucumbenciais }}
                                            {% if alvara_form.fase_honorarios_sucumbenciais.help_text %}
                                                <small class="form-text text-muted">{{ alvara_form.fase_honorarios_sucumbenciais.help_text }}</small>
                                            {% endif %}
                                            {% if alvara_form.fase_honorarios_sucumbenciais.errors %}
                                                <div class="text-danger small">
                                                    {% for error in alvara_form.fase_honorarios_sucumbenciais.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-end">
                                    <button type="button" class="btn btn-secondary me-2" data-bs-toggle="collapse" data-bs-target="#novoAlvaraForm">
                                        <i class="fas fa-times me-1"></i>Cancelar
                                    </button>
                                    <button type="submit" name="create_alvara" class="btn btn-success">
                                        <i class="fas fa-save me-1"></i>Criar Alvará
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% if alvaras %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th><i class="fas fa-user me-1"></i>Cliente</th>
                                    <th><i class="fas fa-money-bill me-1"></i>Valor Principal</th>
                                    <th><i class="fas fa-handshake me-1"></i>Hon. Contratuais</th>
                                    <th><i class="fas fa-gavel me-1"></i>Hon. Sucumbenciais</th>
                                    <th><i class="fas fa-tags me-1"></i>Tipo</th>
                                    <th><i class="fas fa-cog me-1"></i>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alvara in alvaras %}
                                <!-- Main row with essential information -->
                                <tr class="table-light">
                                    <td>
                                        {% if alvara.cliente.cpf %}
                                            <a href="{% url 'cliente_detail' alvara.cliente.cpf %}" class="text-decoration-none">
                                                <strong class="text-primary">{{ alvara.cliente.nome }}</strong>
                                            </a>
                                        {% else %}
                                            <strong class="text-primary">{{ alvara.cliente.nome }}</strong>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="text-success fw-bold">R$ {{ alvara.valor_principal|floatformat:2 }}</span>
                                    </td>
                                    <td>
                                        <span class="text-info">R$ {{ alvara.honorarios_contratuais|floatformat:2 }}</span>
                                    </td>
                                    <td>
                                        <span class="text-warning">R$ {{ alvara.honorarios_sucumbenciais|floatformat:2 }}</span>
                                    </td>
                                    <td>
                                        {% if alvara.tipo == 'aguardando depósito' %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-clock me-1"></i>Aguardando
                                            </span>
                                        {% elif alvara.tipo == 'depósito judicial' %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-university me-1"></i>Depósito
                                            </span>
                                        {% elif alvara.tipo == 'recebido pelo cliente' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Recebido
                                            </span>
                                        {% elif alvara.tipo == 'honorários recebidos' %}
                                            <span class="badge bg-primary">
                                                <i class="fas fa-coins me-1"></i>Honorários
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ alvara.tipo }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-outline-primary btn-sm" 
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#editAlvaraForm-{{ alvara.id }}" 
                                                    aria-expanded="false" 
                                                    title="Editar alvará">
                                                <i class="fas fa-edit me-1"></i>Editar
                                            </button>
                                            <button type="button" class="btn btn-outline-success btn-sm" 
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#recebimentosForm-{{ alvara.id }}" 
                                                    aria-expanded="false" 
                                                    title="Gerenciar recebimentos">
                                                <i class="fas fa-money-bill-wave me-1"></i>Recebimentos
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- Phase and tracking information row -->
                                <tr class="table-secondary small">
                                    <td colspan="6">
                                        <div class="row g-4">
                                            <div class="col-md-4">
                                                <div class="d-flex flex-column">
                                                    <span class="text-muted mb-2">
                                                        <i class="fas fa-layer-group me-1"></i><strong>Fase Principal:</strong>
                                                    </span>
                                                    {% if alvara.fase %}
                                                        <div class="d-flex align-items-center mb-2">
                                                            <div class="fase-color-dot me-2" style="background-color: {{ alvara.fase.cor }};"></div>
                                                            <span>{{ alvara.fase.nome }}</span>
                                                        </div>
                                                        {% if alvara.fase_ultima_alteracao %}
                                                            <div class="text-muted" style="font-size: 0.8rem;">
                                                                <i class="fas fa-clock me-1"></i>
                                                                {{ alvara.fase_ultima_alteracao|date:"d/m/y" }}
                                                                {% if alvara.fase_alterada_por %}
                                                                    <br><small class="text-muted">por {{ alvara.fase_alterada_por }}</small>
                                                                {% endif %}
                                                            </div>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted">Não definida</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="d-flex flex-column">
                                                    <span class="text-muted mb-2">
                                                        <i class="fas fa-coins me-1"></i><strong>Fase Hon. Contratuais:</strong>
                                                    </span>
                                                    {% if alvara.fase_honorarios_contratuais %}
                                                        <div class="d-flex align-items-center mb-2">
                                                            <div class="fase-color-dot me-2" style="background-color: {{ alvara.fase_honorarios_contratuais.cor }};"></div>
                                                            <span>{{ alvara.fase_honorarios_contratuais.nome }}</span>
                                                        </div>
                                                        {% if alvara.fase_honorarios_ultima_alteracao %}
                                                            <div class="text-muted" style="font-size: 0.8rem;">
                                                                <i class="fas fa-clock me-1"></i>
                                                                {{ alvara.fase_honorarios_ultima_alteracao|date:"d/m/y" }}
                                                                {% if alvara.fase_honorarios_alterada_por %}
                                                                    <br><small class="text-muted">por {{ alvara.fase_honorarios_alterada_por }}</small>
                                                                {% endif %}
                                                            </div>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted">Não definida</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="d-flex flex-column">
                                                    <span class="text-muted mb-2">
                                                        <i class="fas fa-balance-scale me-1"></i><strong>Fase Hon. Sucumbenciais:</strong>
                                                    </span>
                                                    {% if alvara.fase_honorarios_sucumbenciais %}
                                                        <div class="d-flex align-items-center mb-2">
                                                            <div class="fase-color-dot me-2" style="background-color: {{ alvara.fase_honorarios_sucumbenciais.cor }};"></div>
                                                            <span>{{ alvara.fase_honorarios_sucumbenciais.nome }}</span>
                                                        </div>
                                                        {% if alvara.fase_honorarios_sucumbenciais_ultima_alteracao %}
                                                            <div class="text-muted" style="font-size: 0.8rem;">
                                                                <i class="fas fa-clock me-1"></i>
                                                                {{ alvara.fase_honorarios_sucumbenciais_ultima_alteracao|date:"d/m/y" }}
                                                                {% if alvara.fase_honorarios_sucumbenciais_alterada_por %}
                                                                    <br><small class="text-muted">por {{ alvara.fase_honorarios_sucumbenciais_alterada_por }}</small>
                                                                {% endif %}
                                                            </div>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted">Não definida</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- Dropdown Edit Form for this Alvará -->
                                <tr>
                                    <td colspan="6" class="p-0">
                                        <div class="collapse" id="editAlvaraForm-{{ alvara.id }}">
                                            <div class="card card-body m-2 bg-light">
                                                <form method="post" action="{% url 'precatorio_detalhe' precatorio.cnj %}">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="alvara_id" value="{{ alvara.id }}">
                                                    
                                                    <div class="row mb-3">
                                                        <div class="col-12">
                                                            <h6 class="text-primary mb-3">
                                                                <i class="fas fa-edit me-2"></i>Editar Alvará - {{ alvara.cliente.nome }}
                                                            </h6>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="row g-3">
                                                        <div class="col-md-4">
                                                            <label for="valor_principal_{{ alvara.id }}" class="form-label">Valor Principal</label>
                                                            <div class="input-group input-group-sm">
                                                                <span class="input-group-text">R$</span>
                                                                <input type="text" class="form-control brazilian-currency" 
                                                                       id="valor_principal_{{ alvara.id }}" 
                                                                       name="valor_principal" 
                                                                       value="{{ alvara.valor_principal }}" required>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="col-md-4">
                                                            <label for="honorarios_contratuais_{{ alvara.id }}" class="form-label">Hon. Contratuais</label>
                                                            <div class="input-group input-group-sm">
                                                                <span class="input-group-text">R$</span>
                                                                <input type="text" class="form-control brazilian-currency" 
                                                                       id="honorarios_contratuais_{{ alvara.id }}" 
                                                                       name="honorarios_contratuais" 
                                                                       value="{{ alvara.honorarios_contratuais }}">
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="col-md-4">
                                                            <label for="honorarios_sucumbenciais_{{ alvara.id }}" class="form-label">Hon. Sucumbenciais</label>
                                                            <div class="input-group input-group-sm">
                                                                <span class="input-group-text">R$</span>
                                                                <input type="text" class="form-control brazilian-currency" 
                                                                       id="honorarios_sucumbenciais_{{ alvara.id }}" 
                                                                       name="honorarios_sucumbenciais" 
                                                                       value="{{ alvara.honorarios_sucumbenciais }}">
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="col-md-3">
                                                            <label for="tipo_{{ alvara.id }}" class="form-label">Tipo</label>
                                                            <select class="form-select form-select-sm" id="tipo_{{ alvara.id }}" name="tipo">
                                                                <option value="">Selecione o tipo</option>
                                                                <option value="ordem cronológica" {% if alvara.tipo == 'ordem cronológica' %}selected{% endif %}>Ordem cronológica</option>
                                                                <option value="prioridade" {% if alvara.tipo == 'prioridade' %}selected{% endif %}>Prioridade</option>
                                                                <option value="acordo" {% if alvara.tipo == 'acordo' %}selected{% endif %}>Acordo</option>
                                                            </select>
                                                        </div>
                                                        
                                                        <div class="col-md-3">
                                                            <label for="fase_{{ alvara.id }}" class="form-label">Fase Principal</label>
                                                            <select class="form-select form-select-sm" id="fase_{{ alvara.id }}" name="fase">
                                                                <option value="">Selecione a fase principal</option>
                                                                {% for fase in alvara_fases %}
                                                                    <option value="{{ fase.id }}" {% if alvara.fase and alvara.fase.id == fase.id %}selected{% endif %}>
                                                                        {{ fase.nome }}
                                                                    </option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        
                                                        <div class="col-md-3">
                                                            <label for="fase_honorarios_contratuais_{{ alvara.id }}" class="form-label">Fase Hon. Contratuais</label>
                                                            <select class="form-select form-select-sm" id="fase_honorarios_contratuais_{{ alvara.id }}" name="fase_honorarios_contratuais">
                                                                <option value="">Selecione a fase honorários</option>
                                                                {% for fase_hon in fases_honorarios_contratuais %}
                                                                    <option value="{{ fase_hon.id }}" {% if alvara.fase_honorarios_contratuais and alvara.fase_honorarios_contratuais.id == fase_hon.id %}selected{% endif %}>
                                                                        {{ fase_hon.nome }}
                                                                    </option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        
                                                        <div class="col-md-3">
                                                            <label for="fase_honorarios_sucumbenciais_{{ alvara.id }}" class="form-label">Fase Hon. Sucumbenciais</label>
                                                            <select class="form-select form-select-sm" id="fase_honorarios_sucumbenciais_{{ alvara.id }}" name="fase_honorarios_sucumbenciais">
                                                                <option value="">Selecione a fase honorários</option>
                                                                {% for fase_sucumb in fases_honorarios_sucumbenciais %}
                                                                    <option value="{{ fase_sucumb.id }}" {% if alvara.fase_honorarios_sucumbenciais and alvara.fase_honorarios_sucumbenciais.id == fase_sucumb.id %}selected{% endif %}>
                                                                        {{ fase_sucumb.nome }}
                                                                    </option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="row mt-3">
                                                        <div class="col-12">
                                                            <div class="d-flex justify-content-between">
                                                                <div class="btn-group">
                                                                    <button type="button" class="btn btn-secondary btn-sm" 
                                                                            data-bs-toggle="collapse" 
                                                                            data-bs-target="#editAlvaraForm-{{ alvara.id }}">
                                                                        <i class="fas fa-times me-1"></i>Cancelar
                                                                    </button>
                                                                    <button type="submit" name="update_alvara" class="btn btn-success btn-sm">
                                                                        <i class="fas fa-save me-1"></i>Salvar Alterações
                                                                    </button>
                                                                </div>
                                                                
                                                                <button type="button" class="btn btn-danger btn-sm" 
                                                                        data-bs-toggle="modal" 
                                                                        data-bs-target="#deleteAlvaraModal-{{ alvara.id }}">
                                                                    <i class="fas fa-trash me-1"></i>Excluir Alvará
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- Delete Confirmation Modal -->
                                <div class="modal fade" id="deleteAlvaraModal-{{ alvara.id }}" tabindex="-1" aria-labelledby="deleteAlvaraModalLabel-{{ alvara.id }}" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header bg-danger text-white">
                                                <h5 class="modal-title" id="deleteAlvaraModalLabel-{{ alvara.id }}">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Exclusão
                                                </h5>
                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="text-center">
                                                    <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
                                                    <h6>Tem certeza que deseja excluir este alvará?</h6>
                                                    <p class="text-muted mb-0">
                                                        <strong>Cliente:</strong> {{ alvara.cliente.nome }}<br>
                                                        <strong>Valor:</strong> R$ {{ alvara.valor_principal|floatformat:2 }}
                                                    </p>
                                                    <div class="alert alert-warning mt-3">
                                                        <small><i class="fas fa-warning me-1"></i>Esta ação não pode ser desfeita!</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    <i class="fas fa-times me-1"></i>Cancelar
                                                </button>
                                                <form method="post" action="{% url 'precatorio_detalhe' precatorio.cnj %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="alvara_id" value="{{ alvara.id }}">
                                                    <button type="submit" name="delete_alvara" class="btn btn-danger">
                                                        <i class="fas fa-trash me-1"></i>Excluir Definitivamente
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Payments Management Section -->
                                <tr>
                                    <td colspan="6" class="p-0">
                                        <div class="collapse" id="recebimentosForm-{{ alvara.id }}">
                                            <div class="card card-body m-2 bg-light-subtle">
                                                <div class="row mb-3">
                                                    <div class="col-12">
                                                        <h6 class="text-success mb-3">
                                                            <i class="fas fa-money-bill-wave me-2"></i>Recebimentos - {{ alvara.cliente.nome }}
                                                        </h6>
                                                    </div>
                                                </div>
                                                
                                                <!-- Existing Payments Display -->
                                                {% if alvara.recebimentos.all %}
                                                <div class="row mb-4">
                                                    <div class="col-12">
                                                        <h6 class="text-muted mb-2">
                                                            <i class="fas fa-list me-1"></i>Recebimentos Existentes
                                                        </h6>
                                                        <div class="table-responsive">
                                                            <table class="table table-sm table-striped">
                                                                <thead class="table-success">
                                                                    <tr>
                                                                        <th>Documento</th>
                                                                        <th>Data</th>
                                                                        <th>Tipo</th>
                                                                        <th>Valor</th>
                                                                        <th>Conta Bancária</th>
                                                                        <th>Ações</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {% for recebimento in alvara.recebimentos.all %}
                                                                    <tr>
                                                                        <td>
                                                                            <strong>{{ recebimento.numero_documento }}</strong>
                                                                        </td>
                                                                        <td>{{ recebimento.data|date:"d/m/Y" }}</td>
                                                                        <td>
                                                                            <span class="badge bg-info text-dark">{{ recebimento.get_tipo_display }}</span>
                                                                        </td>
                                                                        <td>
                                                                            <span class="text-success fw-bold">{{ recebimento.valor_formatado }}</span>
                                                                        </td>
                                                                        <td>
                                                                            <small>
                                                                                <strong>{{ recebimento.conta_bancaria.banco }}</strong><br>
                                                                                Ag: {{ recebimento.conta_bancaria.agencia }} - 
                                                                                Cc: {{ recebimento.conta_bancaria.conta }}
                                                                            </small>
                                                                        </td>
                                                                        <td>
                                                                            <a href="{% url 'editar_recebimento' recebimento.numero_documento %}" 
                                                                               class="btn btn-outline-primary btn-sm" title="Editar recebimento">
                                                                                <i class="fas fa-edit me-1"></i>Editar
                                                                            </a>
                                                                        </td>
                                                                    </tr>
                                                                    {% endfor %}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                        
                                                        <!-- Payment Summary -->
                                                        <div class="row mt-2">
                                                            <div class="col-md-6">
                                                                <div class="alert alert-success py-2">
                                                                    <strong>Total Pago:</strong> 
                                                                    {{ alvara.recebimentos.all|length|floatformat:0 }} recebimento{{ alvara.recebimentos.all|length|pluralize }}
                                                                    <!-- TODO: Add sum calculation -->
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <hr>
                                                {% endif %}
                                                
                                                <!-- New Payment Form -->
                                                <div class="row">
                                                    <div class="col-12">
                                                        <h6 class="text-primary mb-3">
                                                            <i class="fas fa-plus me-1"></i>Novo Recebimento
                                                        </h6>
                                                        
                                                        <form method="post" action="{% url 'novo_recebimento' alvara.id %}" id="novoRecebimentoForm-{{ alvara.id }}">
                                                            {% csrf_token %}
                                                            
                                                            <div class="row g-3">
                                                                <div class="col-md-3">
                                                                    <label for="numero_documento_{{ alvara.id }}" class="form-label">Número do Documento</label>
                                                                    <input type="text" class="form-control form-control-sm" 
                                                                           id="numero_documento_{{ alvara.id }}" 
                                                                           name="numero_documento" 
                                                                           placeholder="Ex: PAG-2024-001"
                                                                           required>
                                                                </div>
                                                                
                                                                <div class="col-md-3">
                                                                    <label for="data_{{ alvara.id }}" class="form-label">Data do Recebimento</label>
                                                                    <input type="date" class="form-control form-control-sm" 
                                                                           id="data_{{ alvara.id }}" 
                                                                           name="data" 
                                                                           value="{% now 'Y-m-d' %}"
                                                                           required>
                                                                </div>
                                                                
                                                                <div class="col-md-3">
                                                                    <label for="tipo_{{ alvara.id }}" class="form-label">Tipo</label>
                                                                    <select class="form-select form-select-sm" 
                                                                            id="tipo_{{ alvara.id }}" 
                                                                            name="tipo"
                                                                            required>
                                                                        <option value="">Selecione o tipo</option>
                                                                        <option value="Hon. contratuais">Hon. contratuais</option>
                                                                        <option value="Hon. sucumbenciais">Hon. sucumbenciais</option>
                                                                    </select>
                                                                </div>
                                                                
                                                                <div class="col-md-3">
                                                                    <label for="valor_{{ alvara.id }}" class="form-label">Valor</label>
                                                                    <div class="input-group input-group-sm">
                                                                        <span class="input-group-text">R$</span>
                                                                        <input type="text" class="form-control brazilian-currency" 
                                                                               id="valor_{{ alvara.id }}" 
                                                                               name="valor" 
                                                                               placeholder="0,00"
                                                                               required>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="col-12">
                                                                    <label for="conta_bancaria_{{ alvara.id }}" class="form-label">Conta Bancária</label>
                                                                    <select class="form-select form-select-sm" 
                                                                            id="conta_bancaria_{{ alvara.id }}" 
                                                                            name="conta_bancaria"
                                                                            required>
                                                                        <option value="">Selecione a conta bancária</option>
                                                                        {% for conta in contas_bancarias %}
                                                                            <option value="{{ conta.id }}">
                                                                                {{ conta.banco }} - Ag: {{ conta.agencia }} - Cc: {{ conta.conta }} ({{ conta.tipo_de_conta }})
                                                                            </option>
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="row mt-3">
                                                                <div class="col-12">
                                                                    <div class="d-flex justify-content-between">
                                                                        <div class="btn-group">
                                                                            <button type="button" class="btn btn-secondary btn-sm" 
                                                                                    data-bs-toggle="collapse" 
                                                                                    data-bs-target="#recebimentosForm-{{ alvara.id }}">
                                                                                <i class="fas fa-times me-1"></i>Cancelar
                                                                            </button>
                                                                            <button type="submit" class="btn btn-success btn-sm">
                                                                                <i class="fas fa-save me-1"></i>Criar Recebimento
                                                                            </button>
                                                                        </div>
                                                                        
                                                                        <small class="text-muted align-self-center">
                                                                            <i class="fas fa-info-circle me-1"></i>
                                                                            Recebimento será vinculado a este alvará
                                                                        </small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Alvará Summary -->
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-light rounded">
                                <i class="fas fa-file-contract fa-2x text-success mb-2"></i>
                                <h6 class="mb-0">Total de Alvarás</h6>
                                <span class="text-muted">{{ alvaras.count }}</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-light rounded">
                                <i class="fas fa-money-bill-wave fa-2x text-success mb-2"></i>
                                <h6 class="mb-0">Valor Principal Total</h6>
                                <span class="text-success fw-bold">
                                    R$ {% for alvara in alvaras %}{{ alvara.valor_principal|add:0 }}{% if not forloop.last %}+{% endif %}{% empty %}0.00{% endfor %}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-light rounded">
                                <i class="fas fa-handshake fa-2x text-info mb-2"></i>
                                <h6 class="mb-0">Hon. Contratuais Total</h6>
                                <span class="text-info fw-bold">
                                    R$ {% for alvara in alvaras %}{{ alvara.honorarios_contratuais|add:0 }}{% if not forloop.last %}+{% endif %}{% empty %}0.00{% endfor %}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-light rounded">
                                <i class="fas fa-gavel fa-2x text-warning mb-2"></i>
                                <h6 class="mb-0">Hon. Sucumbenciais Total</h6>
                                <span class="text-warning fw-bold">
                                    R$ {% for alvara in alvaras %}{{ alvara.honorarios_sucumbenciais|add:0 }}{% if not forloop.last %}+{% endif %}{% empty %}0.00{% endfor %}
                                </span>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-file-contract fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Nenhum alvará emitido</h5>
                        <p class="text-muted">Este precatório ainda não possui alvarás associados.</p>
                        <button type="button" class="btn btn-success" data-bs-toggle="collapse" data-bs-target="#novoAlvaraForm">
                            <i class="fas fa-plus me-1"></i>Emitir Primeiro Alvará
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>


<!-- Delete Precatorio Modal -->
<div class="modal fade" id="deletePrecatorioModal" tabindex="-1" aria-labelledby="deletePrecatorioModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deletePrecatorioModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="fas fa-file-times fa-3x text-danger mb-3"></i>
                    <h5>Tem certeza que deseja excluir este precatório?</h5>
                </div>
                
                <div class="alert alert-warning">
                    <strong><i class="fas fa-gavel me-2"></i>Precatório:</strong> {{ precatorio.cnj }}<br>
                    <strong><i class="fas fa-building me-2"></i>Origem:</strong> {{ precatorio.origem|default:"Não informado" }}<br>
                    <strong><i class="fas fa-money-bill-wave me-2"></i>Valor de Face:</strong> R$ {{ precatorio.valor_de_face|floatformat:2 }}
                </div>
                
                <div class="alert alert-danger">
                    <strong><i class="fas fa-exclamation-triangle me-2"></i>Atenção:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Esta ação não pode ser desfeita</li>
                        <li>O precatório só pode ser excluído se não estiver associado a clientes, alvarás ou requerimentos</li>
                        <li>Todos os dados do precatório serão permanentemente removidos</li>
                        <li>Histórico e relacionamentos serão perdidos</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <form method="post" action="{% url 'delete_precatorio' precatorio.cnj %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i>Excluir Definitivamente
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
    .card {
        transition: box-shadow 0.3s ease;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .badge {
        font-size: 0.8em;
    }
    
    .form-check-input {
        margin-top: 0.3em;
    }
    
    .fs-5 {
        font-size: 1.25rem;
    }
    
    .fs-6 {
        font-size: 0.875rem;
    }
    
    .fw-bold {
        font-weight: bold;
    }
    
    .fase-color-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        border: 1px solid #dee2e6;
    }
    
    .form-control:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
    
    .btn-success:hover {
        background-color: #218838;
        border-color: #1e7e34;
    }
    
    h6.text-muted {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.875rem;
        letter-spacing: 0.5px;
    }
    
    .inline-edit-form {
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
function toggleStatusPagamentoEdit() {
    const display = document.getElementById('status-pagamento-display');
    const edit = document.getElementById('status-pagamento-edit');
    
    if (display.style.display === 'none') {
        display.style.display = 'block';
        edit.style.display = 'none';
    } else {
        display.style.display = 'none';
        edit.style.display = 'block';
        // Focus on the first select when editing
        const firstSelect = edit.querySelector('select');
        if (firstSelect) {
            firstSelect.focus();
        }
    }
}

function toggleObservacaoEdit() {
    const display = document.getElementById('observacao-display');
    const edit = document.getElementById('observacao-edit');
    
    if (display.style.display === 'none') {
        display.style.display = 'block';
        edit.style.display = 'none';
    } else {
        display.style.display = 'none';
        edit.style.display = 'block';
        // Focus on the textarea when editing
        const textarea = edit.querySelector('textarea');
        if (textarea) {
            textarea.focus();
        }
    }
}

function toggleFileEdit() {
    const display = document.getElementById('file-display');
    const edit = document.getElementById('file-edit');
    
    if (display.style.display === 'none') {
        display.style.display = 'block';
        edit.style.display = 'none';
    } else {
        display.style.display = 'none';
        edit.style.display = 'block';
        // Focus on the file input when editing
        const fileInput = edit.querySelector('input[type="file"]');
        if (fileInput) {
            fileInput.focus();
        }
    }
}

function confirmFileDelete() {
    if (confirm('Tem certeza que deseja excluir o arquivo PDF? Esta ação não pode ser desfeita.')) {
        // Submit the hidden delete form
        document.getElementById('delete-file-form').submit();
    }
}
</script>
{% endblock %}
